angular.module("spicyTaste",["ngRoute","angular-md5","ngMaterial","ngAnimate","ngMessages"]),angular.module("spicyTaste").constant("CONFIG",{FacebookAppId:"1563567387253468",AWS_ACCESS_KEY:"AKIAISDEEB5CEMMQTZPA",AWS_SECRECT_KEY:"S197rM/ivjnDW51R8kJJC6jP+Yi8hCZDuG1HHBmB",LATEST_COUNT:10,LOCAL_STORAGE_KEY:"spicyTasteUser"}),angular.module("spicyTaste").config(["$mdThemingProvider","$mdIconProvider",function(e,t){"use strict";var n=e.extendPalette("deep-orange",{500:"f27242"}),i=e.extendPalette("blue",{500:"6984b4",600:"6984b4"});e.definePalette("primaryOrange",n),e.definePalette("primaryBlue",i),e.theme("default").primaryPalette("primaryOrange").accentPalette("deep-orange"),e.theme("blue").primaryPalette("primaryBlue"),t.icon("menu","svg/ic_menu_24px.svg").icon("share","svg/ic_share_48px.svg").icon("login","svg/ic_account_circle_24px.svg").icon("recipes","svg/ic_event_note_48px.svg").icon("restaurants","svg/ic_restaurant_menu_48px.svg").icon("ingredients","svg/ic_receipt_48px.svg").icon("arrow","svg/ic_arrow_drop_up_48px.svg").icon("more","svg/ic_more_24px.svg").icon("time1","svg/ic_av_timer_24px.svg").icon("time2","svg/ic_access_time_24px.svg").icon("exit","svg/ic_exit_to_app_48px.svg").icon("photo","svg/ic_mms_24px.svg").icon("check","svg/ic_check_circle_24px.svg").icon("facebook","svg/facebook.svg").icon("twitter","svg/twitter.svg").icon("pinterest","svg/pinterest.svg").icon("comments","svg/ic_chat_48px.svg").icon("menu","svg/ic_menu_48px.svg").icon("favorite","svg/ic_favorite_24px.svg").icon("delete","svg/ic_delete_48px.svg").icon("add","svg/ic_add_circle_outline_48px.svg").icon("arrow-down","svg/ic_expand_more_48px.svg").icon("play","svg/ic_play_circle_outline_48px.svg").icon("search","svg/ic_search_48px.svg").icon("pin","svg/ic_attach_file_48px.svg").icon("clear","svg/ic_clear_all_48px.svg").icon("next","svg/ic_chevron_right_48px.svg").icon("pre","svg/ic_chevron_left_48px.svg").icon("edit","svg/ic_edit_48px.svg").icon("email","svg/ic_email_48px.svg").icon("lock","svg/ic_lock_outline_48px.svg").icon("user","svg/ic_person_outline_48px.svg").icon("go","svg/ic_play_circle_fill_48px.svg").icon("upload","svg/ic_cloud_upload_48px.svg").icon("send","svg/ic_send_48px.svg").icon("upload-error","svg/ic_cloud_off_48px.svg").icon("tips","svg/ic_note_add_48px.svg")}]),angular.module("spicyTaste").run(["$rootScope","$location","$window","UserService","CONFIG",function(e,t,n,i,o){"use strict";n.fbAsyncInit=function(){FB.init({appId:o.FacebookAppId,cookie:!0,xfbml:!0,status:!0,version:"v2.5"}),i.watchFBAuthChange()},function(e,t,n){var i,o=e.getElementsByTagName(t)[0];e.getElementById(n)||(i=e.createElement(t),i.id=n,i.src="//connect.facebook.net/en_US/sdk.js",o.parentNode.insertBefore(i,o))}(document,"script","facebook-jssdk"),window.pAsyncInit=function(){PDK.init({appId:"4803431288025393530",cookie:!0})},function(e,t,n){var i,o=e.getElementsByTagName(t)[0];e.getElementById(n)||(i=e.createElement(t),i.id=n,i.src="//assets.pinterest.com/sdk/sdk.js",o.parentNode.insertBefore(i,o))}(document,"script","pinterest-jssdk"),e.$on("$routeChangeStart",function(e,n){n&&n.access&&i.authorize(n.access.requirePermissions).then(function(e){e||(n.access.requirePermissions.indexOf("ADMIN")>=0?t.path("not-authorize").replace():t.path("/share").replace())},function(){n.access.requirePermissions.indexOf("ADMIN")>=0?t.path("not-authorize").replace():t.path("/share").replace()})}),e.$watch("currentUser",function(){e.$broadcast("logined")})}]),angular.module("spicyTaste").config(["$locationProvider","$routeProvider",function(e,t){"use strict";e.html5Mode(!0),t.when("/",{templateUrl:"ng/views/pages/home.html",controller:"HomeController",controllerAs:"home"}).when("/share",{templateUrl:"ng/views/pages/dish/share.html",controller:"DishShareController",controllerAs:"share"}).when("/themes",{templateUrl:"ng/views/pages/theme/all.html",controller:"ThemeAllController",controllerAs:"themeAll"}).when("/themes/:name",{templateUrl:"/ng/views/pages/theme/show.html",controller:"ThemeShowController",controllerAs:"themeShow"}).when("/recipts",{templateUrl:"ng/views/pages/dish/all.html",controller:"DishAllController",controllerAs:"dishAll"}).when("/dishes/:dishId",{templateUrl:"ng/views/pages/dish/show.html",controller:"DishShowController",controllerAs:"dishShow"}).when("/dishes/:dishId/instructions",{templateUrl:"ng/views/pages/dish/instruction.html",controller:"DishInstructionController",controllerAs:"dishInstruction"}).when("/me/dishes/:dishId",{templateUrl:"ng/views/pages/dish/edit.html",controller:"DishEditController",controllerAs:"dishManage",access:{requirePermissions:["READER"]}}).when("/me/dishes/:dishId/instructions",{templateUrl:"ng/views/pages/dish/edit-instructions.html",controller:"DishEditInstructionController",controllerAs:"instructionEdit",access:{requirePermissions:["READER"]}}).when("/login",{templateUrl:"ng/views/pages/user/login.html",controller:"LoginController",controllerAs:"login"}).when("/me",{templateUrl:"ng/views/pages/user/me.html",controller:"ProfileController",controllerAs:"profile",access:{requirePermissions:["READER"]}}).when("/not-authorize",{templateUrl:"ng/views/pages/not-authorize.html"}).when("/admin",{templateUrl:"/ng/views/pages/admin/index.html",access:{requirePermissions:["ADMIN"]}}).when("/admin/themes",{templateUrl:"/ng/views/pages/admin/theme/list.html",controller:"ThemeAdminListController",controllerAs:"themeList",access:{requirePermissions:["ADMIN"]}}).when("/admin/themes/:id",{templateUrl:"ng/views/pages/admin/theme/edit.html",controller:"ThemeAdminEditController",controllerAs:"themeEdit",access:{requirePermissions:["AdMIN"]}}).when("/admin/dishes",{templateUrl:"ng/views/pages/admin/dish/list.html",controller:"DishAdminListController",controllerAs:"dishList",access:{requirePermissions:["ADMIN"]}})}]),angular.module("spicyTaste").controller("HomeController",["$scope","$mdMedia","DishService","CONFIG",function(e,t,n,i){"use strict";function o(){e.setMenuBar({}),r.recipeTiles=[],e.$watch(function(){return t("sm")},function(t){e.smallScreen=t}),s()}function s(){n.limit(i.LATEST_COUNT).success(function(e){angular.forEach(e,function(e,t){var i={image:e.imageUrl,title:e.name,id:e._id,prepTime:e.prepTime,totalTime:e.totalTime,difficulty:n.getDifficulties()[e.difficulty-1],tags:e.tags,span:{row:1,col:1}};switch(t+1){case 1:i.span.row=i.span.col=2;break;case 2:case 3:break;case 4:i.span.col=2;break;case 5:case 6:break;case 7:i.span.row=i.span.col=2;break;case 8:case 9:break;case 10:i.span.col=2}r.recipeTiles.push(i)})})}var r=this;o()}]),angular.module("spicyTaste").controller("LoginController",["$rootScope","$scope","$mdDialog","UserService","md5",function(e,t,n,i,o){"use strict";function s(){r.title=r.dialogTitle,r.email="",r.password="",r.userName="",r.loginFailed=!1}var r=this;r.fbLogin=function(){i.fbLogin(),n.hide()},r.login=function(){i.login(r.email,r.password).then(function(){n.hide()},function(){r.loginFailed=!0})},r.signUp=function(){var e={userName:r.userName,email:r.email,password:r.password,photoUrl:"http://www.gravatar.com/avatar/"+o.createHash(r.email)};i.create(e).then(function(){n.hide()},function(){r.loginFailed=!0})},s()}]),angular.module("spicyTaste").controller("MainController",["$rootScope","$scope","$location","$mdDialog","$http","SessionService","UserService","CONFIG",function(e,t,n,i,o,s,r,c){"use strict";function a(){u.showMobileMenu=!1,u.scrollTargetReached=!1,u.defaultMenu={primaryTheme:!1,hidden:!1,text:"SPICY TASTE"},u.menuBar=u.defaultMenu;var t=s.getLocal(c.LOCAL_STORAGE_KEY);t&&(console.log("token",t),o.defaults.headers.common["X-Auth"]=t,r.getCurrentUser().success(function(t){e.currentUser=t}))}var u=this;u.toggleMobileMenu=function(){u.showMobileMenu=!u.showMobileMenu},t.setMenuBar=function(e){u.menuBar={},angular.extend(u.menuBar,u.defaultMenu,e)},t.showLoginDialog=function(e,t,n){var o=i.show({clickOutsideToClose:!0,templateUrl:"ng/views/dialogs/login.html",targetEvent:e,controller:"LoginController",controllerAs:"login",locals:{dialogTitle:n},bindToController:!0});return t?o:void 0},a()}]),angular.module("spicyTaste").controller("ProfileController",["UtilityService","$location","$scope","$rootScope","$timeout","UserService","DishService",function(e,t,n,i,o,s,r){"use strict";function c(){n.setMenuBar({primaryTheme:!0}),s.getProfile().success(function(e){a.user=e.user;for(var t=0;t<a.user.favouriteDishes.length;t++)a.user.favouriteDishes[t].difficultyText=r.getDifficultyText(a.user.favouriteDishes[t].difficulty);a.reciptsCount=e.reciptsCount})}var a=this;a.logout=function(){s.logout().then(function(){t.path("/")})},a.getRecipts=function(){0!==a.reciptsCount&&(n.showSpinner=!0,r.searchByAuthor(i.currentUser._id).success(function(e){a.allRecipts=e}))},n.$on("onRepeatLast",function(){o(function(){n.showSpinner=!1},400)}),n.$on("uploaded",function(t,n){s.updateInfo(a.user._id,"photoUrl",n).success(function(){i.currentUser.photoUrl=n}).error(function(){e.showStatusToast(!1,"Error, try upload the photo again.")})}),c()}]),angular.module("spicyTaste").directive("contenteditable",function(){"use strict";return{require:"ngModel",restrict:"A",link:function(e,t,n,i){i.$render=function(){t.html(i.$viewValue||"")},t.bind("blur",function(){e.$apply(function(){i.$setViewValue(t.html())})})}}}),angular.module("spicyTaste").directive("flipbook",function(){return{transclude:!1,restrict:"E",replace:!0,templateUrl:"ng/views/templates/flipbook.html",scope:{dish:"="}}}),angular.module("spicyTaste").directive("focus",function(){"use strict";return{restrict:"A",scope:{trigger:"@focus"},link:{post:function(e,t){e.$watch("trigger",function(e){"true"===e&&t[0].focus()})}}}}),angular.module("spicyTaste").directive("focusOn",function(){return{restrict:"A",scope:{focusValue:"=focusOn"},link:function(e,t){e.$watch("focusValue",function(e,n){e&&!n&&t[0].focus()})}}}),angular.module("spicyTaste").directive("imageUpload",["UtilityService",function(e){"use strict";return{restrict:"E",scope:{image:"="},replace:!0,transclude:!1,templateUrl:"ng/views/templates/imageUpload.html",controller:["$scope",function(e){e.uploadStatus={progress:0,done:!1,error:!1,imageUrl:""},e.changeUploadStatus=function(t){angular.extend(e.uploadStatus,t),t.imageUrl&&""!==t.imageUrl.trim()&&(e.image=t.imageUrl,e.$emit("uploaded",t.imageUrl)),e.$apply()}}],link:function(t,n){var i=n.find("input.file");i.on("change",function(n){t.changeUploadStatus({progress:0,error:!1,done:!1});var i=n.target.files,o=i[0];e.awsUpload(o,null,t.changeUploadStatus)})}}}]),angular.module("spicyTaste").directive("onLastRepeat",["$timeout",function(e){"use strict";return function(t,n,i){t.$last&&e(function(){t.$emit("onRepeatLast",n,i)},0)}}]),angular.module("spicyTaste").directive("originalSrc",function(){"use strict";return{restrict:"A",scope:{originalSrc:"@"},link:function(e,t,n){t.on("load",function(){t.attr("src",e.originalSrc),t.css("background","none")})}}}),angular.module("spicyTaste").directive("scrollTo",function(){return{restrict:"A",link:function(e,t,n){var i=$(n.scrollTo);t.on("click",function(){$("html, body").animate({scrollTop:i.offset().top},600)})}}}),angular.module("spicyTaste").directive("showTime",["$window","UtilityService",function(e,t){"use strict";return{restrict:"A",scope:!0,link:function(n,i,o){var s=n.$eval(o.showTime),r=0;angular.isUndefined(s)||(r=s.offset);var c=t.debounce(function(){if(!i.hasClass("viewed")){var t=angular.element(e).scrollTop(),n=t+angular.element(e).height(),o=i.offset().top,s=o+i.height();0!==r&&(t-o>=0?o+=r:s-=r),n>=s&&o>=t&&i.removeClass("notViewed").addClass("viewed")}},200,!0);angular.element(e).on("scroll",c),n.$on("$destroy",c)}}}]),angular.module("spicyTaste").directive("socialShares",["SocialService","$location",function(e,t){"use strict";return{restrict:"E",replace:!0,templateUrl:"ng/views/templates/socialShares.html",scope:{recipt:"="},link:function(n,i){n.$watch("recipt",function(n){if(n.name){var o=n;o.blog?o.description=o.blog.length>200?o.blog.substring(0,200)+"...":o.blog:o.description="Come to try this delicious",i.find("#btnFB").click(function(){var n={picture:o.imageUrl,caption:o.name,description:o.description,redirect_uri:t.absUrl()};t.absUrl().indexOf("localhost")<0&&(n.link=t.absUrl()),e.fbShare(n)}),i.find("#btnPinterest").click(function(){PDK.pin(o.imageUrl,o.name,t.absUrl(),function(){})})}})}}}]),angular.module("spicyTaste").directive("topMenuReached",["$window","UtilityService",function(e,t){"use strict";return{restrict:"A",scope:!0,link:function(n,i,o){var s=i.offset().top-64,r={primaryTheme:!1,hidden:!1,text:"spicy taste"},c=n.$eval(o.topMenuReached),a=e.pageYOffset;a>=s&&n.setMenuBar(c);var u=t.debounce(function(){console.log("debounce called"),e.pageYOffset>=s?n.setMenuBar(c):n.setMenuBar(r),n.$apply()},150);angular.element(e).on("scroll",u),n.$on("$destroy",u)}}}]),angular.module("spicyTaste").factory("CommentService",["$http",function(e){"use strict";var t={},n="/api/comments";return t.getByDish=function(t,i){var o=n+"?dishId="+t;return i&&(o+="&limit="+i),e.get(o)},t.countByDish=function(t){return e.get(n+"/count/?dish="+t)},t}]),angular.module("spicyTaste").factory("DishService",["$http",function(e){"use strict";var t={},n="/api/dishes/";return t.all=function(){return e.get(n)},t.search=function(t){return e.get(n+"?search="+t)},t.searchByCategory=function(t){return e.get(n+"?category="+t)},t.searchByAuthor=function(t){return e.get(n+"?createdBy="+t)},t.limit=function(t){return e.get(n+"?limit="+t)},t.relate=function(t,n,i){return e({method:"GET",url:"/api/dishes",params:{id:t,limit:i,"tags[]":n}})},t.create=function(t){return e.post(n,t)},t.get=function(t){return e.get(n+t)},t.update=function(t,i){return e.put(n+t,i)},t.submitPhotos=function(t,i){return e.put(n+t+"/photos",i)},t["delete"]=function(t){return e["delete"](n+t)},t.addComment=function(t,i){return e.post(n+t+"/comments",i)},t.getDishWithInstructions=function(t){return e.get(n+t+"/instructions")},t.addInstruction=function(t,i){return e.post(n+t+"/instructions",i)},t.updateInstruction=function(t){return e.put("/api/instructions/"+t._id,t)},t.removeInstruction=function(t,i){return e["delete"](n+t+"/instructions/"+i)},t.getDifficulties=function(){return["初学","容易","一般","较难","专业"]},t.getDifficultyText=function(e){return t.getDifficulties()[e-1]},t}]),angular.module("spicyTaste").factory("SessionService",["$window",function(e){var t={};return t.getLocal=function(t){if(e.localStorage){var n=e.localStorage.getItem(t);return angular.fromJson(n)}return!1},t.setLocal=function(t,n){return e.localStorage&&e.localStorage.setItem(t,angular.toJson(n))},t}]),angular.module("spicyTaste").factory("SocialService",function(){"use strict";var e={};return e.fbShare=function(e){FB.ui({method:"feed",link:e.link,picture:e.picture,caption:e.caption,description:e.description,redirect_uri:e.redirect_uri},function(){})},e}),angular.module("spicyTaste").factory("ThemeService",["$http","$filter",function(e,t){"use strict";var n={};return n.getAll=function(){return e.get("/api/themes")},n.get=function(t){return e.get("/api/themes/"+t)},n.searchBy=function(t){return e.get("/api/themes/?"+t)},n.create=function(t){return e.post("/api/themes/",t)},n.update=function(t,n){return e.put("/api/themes/"+t,n)},n.getOthers=function(e,i){var o="limit="+(i+1);return n.searchBy(o).then(function(n){var o=t("filter")(n.data,{name:e},function(e,t){return t.toLowerCase().trim()!==e.toLowerCase().trim()});return o.length>i?o.splice(0,1):o})},n}]),angular.module("spicyTaste").factory("UserService",["$http","$rootScope","$q","$window","SessionService","CONFIG",function(e,t,n,i,o,s){"use strict";function r(n){return e.defaults.headers.common["X-Auth"]=n.token,o.setLocal(s.LOCAL_STORAGE_KEY,n.token),t.currentUser=n.user,!0}function c(t){return e.post("/api/auth/facebook",t).then(function(e){return r(e.data)},function(){})}var a={},u="/api/users/";return a.fbLogin=function(){FB.login(function(e){"connected"===e.status||"not_authorized"===e.status},{scope:"public_profile,email"})},a.watchFBAuthChange=function(){FB.Event.subscribe("auth.authResponseChange",function(e){"connected"===e.status&&a.getFBUserInfo().then(function(e){t.currentUser?t.currentUser.facebook||a.updateInfo(t.currentUser._id,"facebook",e.facebook):c(e)})})},a.getFBUserInfo=function(){var e=n.defer();return FB.api("/me",{fields:"id, name, email"},function(t){(!t||t.error)&&e.reject("FB api/me error");var n={userName:t.name,email:t.email,photoUrl:"http://graph.facebook.com/"+t.id+"/picture?type=large",facebook:{id:t.id,email:t.email}};e.resolve(n)}),e.promise},a.login=function(t,n){return e.post("/api/auth",{email:t,password:n}).then(function(e){return r(e.data)},function(){return!1})},a.logout=function(){var o=n.defer();return delete e.defaults.headers.common["X-Auth"],i.localStorage.removeItem(s.LOCAL_STORAGE_KEY),FB.getLoginStatus(function(e){"connected"===e.status?FB.logout(function(){o.resolve()}):o.resolve()}),t.currentUser=null,o.promise},a.searchBy=function(t){return e.get("/api/users?"+t).then(function(e){return e.data})},a.getCurrentUser=function(){return e.get("/api/me")},a.getById=function(t){return e.get(u+t).then(function(e){return e.data})},a.getProfile=function(){return e.get("/api/me/profile")},a.create=function(t){return e.post(u,t).then(function(){return a.login(t.email,t.password)})},a.update=function(t){return e.put(u+t.userId,t)},a.updateInfo=function(t,n,i){return e.put(u+t+"/field",{field:n,newValue:i})},a.collect=function(n){return e.put(u+t.currentUser._id+"/dishes/"+n)},a.authorize=function(e){return a.getCurrentUser().success(function(t){return t&&"ADMIN"===t.role?!0:t&&e.indexOf(t.role)>=0?!0:!1}).error(function(e){return console.log("error",e),!1})},a}]),angular.module("spicyTaste").factory("UtilityService",["$timeout","$mdToast","$document","CONFIG",function(e,t,n,i){"use strict";var o={};return o.debounce=function(e,t,n){var i;return function(){var o=this,s=arguments,r=function(){i=null,n||e.apply(o,s)},c=n&&!i;clearTimeout(i),i=setTimeout(r,t),c&&e.apply(o,s)}},o.showStatusToast=function(e,i,o){t.show({controller:["$scope",function(t){t.content=i,t.isSuccess=e}],templateUrl:"ng/views/templates/toast.html",hideDelay:2e3,position:"top right",parent:n[0].querySelector(o)})},o.awsUpload=function(t,n,o){AWS.config.update({accessKeyId:i.AWS_ACCESS_KEY,secretAccessKey:i.AWS_SECRECT_KEY}),AWS.config.region="us-west-2";var s=null===n?"spicytaste-tmp-photos":"spicytaste-photos/"+n,r=new AWS.S3({params:{Bucket:s}}),c={Key:t.name,ContentType:t.type,Body:t,ServerSideEncryption:"AES256"},a=r.putObject(c);return setTimeout(a.abort.bind(a),5e3),o?void a.on("httpError",function(t,n){console.log("upload err",t),o({error:!0}),e(function(){o({error:!1})},300)}).on("httpDone",function(n){o({imageUrl:"https://s3-us-west-2.amazonaws.com/"+s+"/"+t.name}),e(function(){o({done:!0,progress:0})},300)}).on("httpUploadProgress",function(e,t){o({progress:Math.round(e.loaded/e.total*100)})}).on("error",function(e){console.log("aws putObject error",e)}).send():a},o}]),angular.module("spicyTaste").controller("ThemeAdminEditController",["ThemeService","$routeParams","$timeout","DishService",function(e,t,n,i){"use strict";function o(){s.theme={},s.dishes=[],e.get(t.id).success(function(e){s.theme=e}),i.all().success(function(e){s.dishes=e})}var s=this;s.update=function(){e.update(s.theme._id,s.theme).success(function(e){e.success&&(s.updateSuccess=!0,n(function(){s.updateSuccess=!1},800))})},s.addDish=function(e){s.theme.components.push({title:"",displayOrder:s.theme.components.length+1,dish:e})},s.removeComponent=function(e){s.theme.components.splice(e,1)},s.getDisplayOrders=function(){for(var e=[],t=0;t<s.theme.components.length;t++)e.push(t+1);return e},o()}]),angular.module("spicyTaste").controller("ThemeAdminListController",["ThemeService","$location",function(e,t){"use strict";function n(){i.themes={},e.getAll().success(function(e){i.themes=e})}var i=this;i.create=function(){e.create({name:"new theme"}).success(function(e){t.path("/admin/themes/"+e.theme._id)})},n()}]),angular.module("spicyTaste").controller("ThemeAllController",["ThemeService",function(e){"use strict";function t(){e.getAll().success(function(e){n.themes=e})}var n=this;t()}]),angular.module("spicyTaste").controller("ThemeShowController",["ThemeService","$routeParams",function(e,t){"use strict";function n(){i.theme={},e.searchBy("name="+t.name).success(function(e){e&&e.length>0&&(i.theme=e[0],i.theme.slogans=i.theme.slogan.split("|"))}),e.getOthers(t.name,3).then(function(e){i.otherThemes=e})}var i=this;n()}]),angular.module("spicyTaste").controller("DishAdminListController",["DishService",function(e){"use strict";var t=this;e.all().success(function(e){t.dishes=e}),t.deleteDish=function(n){var i=t.dishes[n];e["delete"](i._id).success(function(){t.dishes.splice(n,1)})}}]),angular.module("spicyTaste").controller("DishAllController",["DishService","$scope",function(e,t){"use strict";function n(){t.setMenuBar({}),o.searchText="",o.selectedCategory="",o.hotSearch=["seafood","dessert","spicy","breakfast"],e.all().success(function(e){o.dishes=i(e)})}function i(e){for(var t=0;t<e.length;t++)e[t].blog&&e[t].blog.length>200&&(e[t].blog=e[t].blog.substring(0,Math.floor(100*Math.random())+100)+" ...");return e}var o=this;o.search=function(){""!==o.searchText.trim()&&e.search(o.searchText).success(function(e){o.dishes=i(e)})},o.selectCategory=function(t){o.selectedCategory=t,e.searchByCategory(t).success(function(e){o.dishes=i(e)})},o.showAll=function(){n()},n()}]),angular.module("spicyTaste").controller("DishEditController",["UtilityService","$scope","$mdDialog","$mdToast","$routeParams","DishService","$location","$timeout",function(e,t,n,i,o,s,r,c){"use strict";function a(){l.wizardMode&&(l.showRightPanel?(l.showBottomSheet=!0,l.showHeroButtons=!0):l.showLeftPanel&&(l.showRightPanel=!0))}function u(){t.setMenuBar({}),l.showBottomSheet=!1,l.dish={tags:[],ingredients:[]},"true"===r.search().wizardMode&&(l.wizardMode=!0),c(function(){l.showLeftPanel=!0},500),s.get(o.dishId).success(function(e){l.dish=e,l.dish.photos||(l.dish.photos=[]);for(var t=l.dish.photos.length,n=t;4>n;n++)l.dish.photos.push("")}),l.difficulties=s.getDifficulties(),l.initialTagCount=l.dish.tags.length,l.initialIngredientCount=l.dish.ingredients.length}var l=this;l.submitNext=function(t){t||(t=l.dish.tags.length!==l.initialTagCount||l.dish.ingredients.length!==l.initialIngredientCount),t?s.update(o.dishId,l.dish).success(function(){e.showStatusToast(!0,"Recipe Info Is Updated."),a()}).error(function(){e.showStatusToast(!1,"Error, please try again.")}):a()},l.submitPhotos=function(){s.submitPhotos(o.dishId,l.dish.photos).success(function(t){t.success?(l.wizardMode&&(l.wizardMode=!1),l.showBottomSheet=!1,e.showStatusToast(!0,"Recipe Photos Are Saved.")):e.showStatusToast(!1,"Error, please try again.")})},l.removePhoto=function(e){l.dish.photos[e]=""},u()}]),angular.module("spicyTaste").controller("DishEditInstructionController",["$scope","DishService","$routeParams","UtilityService",function(e,t,n,i){"use strict";function o(){e.setMenuBar({primaryTheme:!0}),s.newInstruction={text:"",photo:""},t.getDishWithInstructions(n.dishId).success(function(e){s.dish=e;for(var t=0;t<s.dish.instructions.length;t++)s.dish.instructions[t].showTips=angular.isString(s.dish.instructions[t].tips)&&""!==s.dish.instructions[t].tips})}var s=this;s.save=function(e){var o=s.dish.instructions[e];o.showTips=""!==o.tips,o._id?t.updateInstruction(o).success(function(){i.showStatusToast(!0,"Instruction Info Is Updated.","md-tabs")}).error(function(){i.showStatusToast(!1,"Error, please try again.","md-tabs")}):t.addInstruction(n.dishId,o).success(function(t){s.dish.instructions[e]._id=t._id,i.showStatusToast(!0,"Instruction Is Saved.","md-tabs")}).error(function(){i.showStatusToast(!1,"Error, please try again.","md-tabs")})},s.remove=function(e){var o=s.dish.instructions[e];o._id?t.removeInstruction(n.dishId,s.dish.instructions[e]._id).success(function(){s.dish.instructions.splice(e,1)}).error(function(){i.showStatusToast(!1,"Error, please try again.","md-tabs")}):s.dish.instructions.splice(e,1)},s.add=function(){s.dish.instructions.push({})},o()}]),angular.module("spicyTaste").controller("DishInstructionController",["DishService","$routeParams",function(e,t){"use strict";function n(){e.getDishWithInstructions(t.dishId).success(function(e){i.dish=e,i.dish.instructions.length>0&&(i.currentIndex=0)})}var i=this;i.isWithinShowRange=function(e){return e>=i.currentIndex-1&&e<=i.currentIndex+1},i.setNavClass=function(e){return e===i.currentIndex-1?"pre":e===i.currentIndex?"current":e===i.currentIndex+1?"next":void 0},i.showNext=function(){i.currentIndex+=1},i.showPre=function(){i.currentIndex-=1},n()}]),angular.module("spicyTaste").controller("DishShareController",["$scope","DishService","$location","$rootScope","$timeout",function(e,t,n,i,o){"use strict";function s(){e.setMenuBar({primaryTheme:!0}),r.newRecipt={name:"",imageUrl:""},r.showLogin=!0,r.isLogined=!angular.isUndefined(i.currentUser)&&null!==i.currentUser}var r=this;e.$on("logined",function(){r.isLogined=!0}),r.create=function(){r.newRecipt.createdBy=i.currentUser._id,t.create(r.newRecipt).success(function(e){n.path("/me/dishes/"+e.dish._id+"?wizardMode=true")})},r.toggleLogin=function(e){e?(r.showSignUp=!1,o(function(){r.showLogin=!0},250)):(r.showLogin=!1,o(function(){r.showSignUp=!0},250))},s()}]),angular.module("spicyTaste").controller("DishShowController",["DishService","UserService","CommentService","$interval","$timeout","$routeParams","$filter","$rootScope","$scope",function(e,t,n,i,o,s,r,c,a){"use strict";function u(){e.addComment(m.dish._id,{content:m.newComment.content,replyTo:m.newComment.replyTo?m.newComment.replyTo._id:null}).success(function(e){m.newComment={},m.commentsCount+=1,m.allComments.unshift(e)})}function l(){n.getByDish(s.dishId,5).success(function(e){if(m.allComments=e,1===m.allComments.length&&(m.currentComment=m.allComments[0]),m.allComments.length>1){var t=0;h=i(function(){m.currentComment=m.allComments[t],t=++t%m.allComments.length},5e3)}})}function d(){m.dish={},m.relatedDishes={},m.currentComment=null,m.newComment={content:""},m.allComments=null,m.progress=0,m.showDifficulty=!0,m.showAllComments=!1,e.get(s.dishId).success(function(t){if(m.dish=t,m.dish.isCollected=!1,m.backgroundImage=m.dish.imageUrl,m.dish.difficultyText="Difficulty: "+e.getDifficultyText(m.dish.difficulty),m.dish.photos&&m.dish.photos.length>0){m.dish.photos.push(m.dish.imageUrl);var n=0,s=m.dish.photos.length,r=i(function(){m.backgroundImage=m.dish.photos[n],n=++n%s},6e3)}var u=20*m.dish.difficulty/2,l=i(function(){m.progress+=2},50,u,!0);m.dish.instructions.length>0&&o(function(){m.showDifficulty=!1},3e3),c.currentUser&&(m.dish.isCollected=c.currentUser.favouriteDishes.indexOf(m.dish._id)>=0),a.$on("$destroy",function(){i.cancel(r),i.cancel(l),angular.isDefined(h)&&(i.cancel(h),h=void 0)})}),l(),n.countByDish(s.dishId).success(function(e){m.commentsCount=e})}var h,m=this;m.collect=function(e){c.currentUser?t.collect(m.dish._id).success(function(){c.currentUser.favouriteDishes.push(m.dish._id),m.dish.isCollected=!0}):a.showLoginDialog(e,!0,"Login or sign up an account to save this recipt as your favourite.").then(function(){t.collect(m.dish._id).success(function(){c.currentUser.favouriteDishes.push(m.dish._id),m.dish.isCollected=!0})})},m.getAllComments=function(){n.getByDish(s.dishId,null).success(function(e){m.showAllComments=!0,m.currentComment=null,m.allComments=e})},m.createComment=function(e){c.currentUser?u():a.showLoginDialog(e,!0,"Login/SignUp first to leave a comment").then(function(){u()})},d()}]);