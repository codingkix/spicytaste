angular.module("spicyTaste",["ngRoute","angular-md5","ngMaterial","ngAnimate","ngMessages"]).constant("CONSTANTS",{FB_APP_ID:0x58e0e66b31adc,FACEBOOK:"FB",EMAIL:"EMAIL",SOCIAL_PASS:"P@ssw0rd",LOCAL_STORAGE_KEY:"spicyTasteUser",LATEST_COUNT:10}),angular.module("spicyTaste").config(["$mdThemingProvider","$mdIconProvider",function(e,t){"use strict";var n=e.extendPalette("deep-orange",{500:"f27242"}),i=e.extendPalette("blue",{500:"6984b4",600:"6984b4"});e.definePalette("primaryOrange",n),e.definePalette("primaryBlue",i),e.theme("default").primaryPalette("primaryOrange").accentPalette("light-green"),e.theme("blue").primaryPalette("primaryBlue"),t.icon("menu","svg/ic_menu_24px.svg").icon("share","svg/ic_share_48px.svg").icon("login","svg/ic_account_circle_24px.svg").icon("recipes","svg/ic_event_note_48px.svg").icon("restaurants","svg/ic_restaurant_menu_48px.svg").icon("ingredients","svg/ic_receipt_48px.svg").icon("arrow","svg/ic_arrow_drop_up_48px.svg").icon("more","svg/ic_more_24px.svg").icon("time1","svg/ic_av_timer_24px.svg").icon("time2","svg/ic_access_time_24px.svg").icon("exit","svg/ic_exit_to_app_48px.svg").icon("photo","svg/ic_mms_24px.svg").icon("check","svg/ic_check_circle_24px.svg").icon("facebook","svg/facebook.svg").icon("twitter","svg/twitter.svg").icon("pinterest","svg/pinterest.svg").icon("comments","svg/ic_chat_48px.svg").icon("menu","svg/ic_menu_48px.svg").icon("favorite","svg/ic_favorite_24px.svg").icon("delete","svg/ic_delete_48px.svg").icon("add","svg/ic_add_circle_outline_48px.svg").icon("arrow-down","svg/ic_expand_more_48px.svg").icon("play","svg/ic_play_circle_outline_48px.svg").icon("search","svg/ic_search_48px.svg").icon("pin","svg/ic_attach_file_48px.svg").icon("clear","svg/ic_clear_all_48px.svg").icon("next","svg/ic_chevron_right_48px.svg").icon("pre","svg/ic_chevron_left_48px.svg").icon("edit","svg/ic_edit_48px.svg")}]),angular.module("spicyTaste").run(["$rootScope","$location","$window","CONSTANTS","UserService",function(e,t,n,i,o){"use strict";n.fbAsyncInit=function(){FB.init({appId:i.FB_APP_ID,cookie:!0,xfbml:!0,version:"v2.2"})},function(e,t,n){var i,o=e.getElementsByTagName(t)[0];e.getElementById(n)||(i=e.createElement(t),i.id=n,i.src="//connect.facebook.net/en_US/sdk.js",o.parentNode.insertBefore(i,o))}(document,"script","facebook-jssdk"),e.$on("$routeChangeStart",function(e,n){n&&n.access&&o.authorize(n.access.requirePermissions).then(function(e){e||t.path("not-authorize").replace()})})}]),angular.module("spicyTaste").config(["$locationProvider","$routeProvider",function(e,t){"use strict";e.html5Mode(!0),t.when("/",{templateUrl:"ng/views/pages/home.html",controller:"HomeController",controllerAs:"home"}).when("/themes",{templateUrl:"ng/views/pages/theme/all.html",controller:"ThemeAllController",controllerAs:"themeAll"}).when("/themes/:name",{templateUrl:"/ng/views/pages/theme/show.html",controller:"ThemeShowController",controllerAs:"themeShow"}).when("/recipts",{templateUrl:"ng/views/pages/dish/all.html",controller:"DishAllController",controllerAs:"dishAll"}).when("/dishes/:dishId",{templateUrl:"ng/views/pages/dish/show.html",controller:"DishShowController",controllerAs:"dishShow"}).when("/dishes/:dishId/instructions",{templateUrl:"ng/views/pages/dish/instruction.html",controller:"DishInstructionController",controllerAs:"dishInstruction"}).when("/admin/themes",{templateUrl:"/ng/views/pages/admin/theme/list.html",controller:"ThemeAdminListController",controllerAs:"themeList",access:{requirePermissions:["Admin"]}}).when("/admin/themes/:id",{templateUrl:"ng/views/pages/admin/theme/edit.html",controller:"ThemeAdminEditController",controllerAs:"themeEdit",access:{requirePermissions:["Admin"]}}).when("/me/dishes",{templateUrl:"ng/views/pages/admin/dish/list.html",controller:"DishListController",controllerAs:"dishList"}).when("/me/dishes/:dishId",{templateUrl:"ng/views/pages/dish/edit.html",controller:"DishEditController",controllerAs:"dishManage"}).when("/login",{templateUrl:"ng/views/pages/user/login.html",controller:"LoginController",controllerAs:"login"}).when("/me",{templateUrl:"ng/views/pages/user/me.html",controller:"ProfileController",controllerAs:"profile"}).when("/not-authorize",{templateUrl:"ng/views/pages/not-authorize.html"})}]),angular.module("spicyTaste").controller("HomeController",["$scope","$mdMedia","DishService","CONSTANTS",function(e,t,n,i){function o(){r.recipeTiles=[],e.$watch(function(){return t("sm")},function(t){e.smallScreen=t}),s()}function s(){n.limit(i.LATEST_COUNT).success(function(e){angular.forEach(e,function(e,t){var n={image:e.imageUrl,title:e.name,id:e._id,prepTime:e.prepTime,totalTime:e.totalTime,difficulty:e.difficulty,tags:e.tags,span:{row:1,col:1}};switch(t+1){case 1:n.span.row=n.span.col=2;break;case 2:case 3:break;case 4:n.span.col=2;case 5:case 6:break;case 7:n.span.row=n.span.col=2;case 8:case 9:break;case 10:n.span.col=2}r.recipeTiles.push(n)})})}var r=this;o()}]),angular.module("spicyTaste").controller("MainController",["$rootScope","$scope","$location","$mdDialog","$http","SessionService","UserService","CONSTANTS",function(e,t,n,i,o,s,r,c){"use strict";function l(e,t,n,i){function r(e){var n=o.defaults.headers.common["X-Auth"];s.setLocal(c.LOCAL_STORAGE_KEY,n),t.hide(e)}var l=this;l.title=e,l.email="",l.password="",l.userName="",l.fbLogin=function(){FB.login(function(e){"connected"===e.status?FB.api("/me",function(e){var t={userName:e.name,email:e.email,password:c.SOCIAL_PASS,photoUrl:"http://graph.facebook.com/"+e.id+"/picture?type=large",linkedSocial:c.FACEBOOK};n.socialLogin(t).then(function(e){e.loginType=c.FACEBOOK,r(e)})}):"not_authorized"===e.status},{scope:"public_profile,email"})},l.login=function(){n.login(l.email,l.password).then(function(e){e.loginType=c.EMAIL,r(e)})},l.signUp=function(){var e={userName:l.userName,email:l.email,password:l.password,photoUrl:"http://www.gravatar.com/avatar/"+i.createHash(l.email),linkedSocial:c.EMAIL};n.create(e).then(function(e){e.loginType=c.EMAIL,r(e)})}}function a(){u.showMobileMenu=!1,u.scrollTargetReached=!1,u.defaultMenu={primaryTheme:!1,hidden:!1,text:"SPICY TASTE"},u.menuBar=u.defaultMenu;var t=s.getLocal(c.LOCAL_STORAGE_KEY);t&&(console.log("token",t),o.defaults.headers.common["X-Auth"]=t,r.getCurrentUser().then(function(t){e.currentUser=t}))}var u=this;u.toggleMobileMenu=function(){u.showMobileMenu=!u.showMobileMenu},t.setMenuBar=function(e){u.menuBar={},angular.extend(u.menuBar,u.defaultMenu,e)},t.showLoginDialog=function(t,n,o){var s=i.show({clickOutsideToClose:!0,templateUrl:"ng/views/dialogs/login.html",targetEvent:t,controller:l,controllerAs:"login",locals:{dialogTitle:o}});return n?s:void s.then(function(t){e.currentUser=t})},l.$inject=["dialogTitle","$mdDialog","UserService","md5"],a()}]),angular.module("spicyTaste").controller("ProfileController",["$location","$scope","$rootScope","$timeout","UserService","DishService",function(e,t,n,i,o,s){"use strict";function r(){t.setMenuBar({primaryTheme:!0}),o.getProfile().success(function(e){c.user=e.user,c.reciptsCount=e.reciptsCount})}var c=this;c.logout=function(){o.logout(),n.currentUser=null,e.path("/")},c.getRecipts=function(){t.showSpinner=!0,s.searchByAuthor(n.currentUser._id).success(function(e){c.allRecipts=e})},c.newRecipt=function(){s.create({name:"new recipt"}).success(function(t){e.path("/me/dishes/"+t.dish._id)})},t.$on("onRepeatLast",function(){i(function(){t.showSpinner=!1},400)}),r()}]),angular.module("spicyTaste").controller("DishListController",["DishService","SocialService","$location",function(e,t,n){var i=this;e.all().success(function(e){i.dishes=e}),i.deleteDish=function(t){var n=i.dishes[t];e["delete"](n._id).success(function(e){i.dishes.splice(t,1)})},i.addDish=function(){e.create({name:"new dish"}).success(function(e){n.path("/admin/dishes/"+e.dish._id)})},i.goToEdit=function(e){n.path("/admin/dishes/"+e)}}]).controller("DishDetailController",["$scope","$location","$rootScope","$routeParams","$filter","$mdDialog","DishService","UserService","SocialService",function(e,t,n,i,o,s,r,c,l){function a(){d.dish={},d.relatedDishes={},r.get(i.dish_id).success(function(e){if(d.dish=e,d.dish.isCollected=!1,r.relate(d.dish._id,d.dish.tags,3).success(function(e){d.relatedDishes=e}),n.currentUser){var t=o("filter")(n.currentUser.favouriteDishes,{_id:d.dish._id},!0);t.length&&(d.dish.isCollected=!0)}})}function u(e,t,n){s.show({targetEvent:t,clickOutsideToClose:!0,templateUrl:"ng/views/dialogs/comment.html",locals:{title:e},controller:h,controllerAs:"comment"}).then(function(e){r.addComment(d.dish._id,{content:e,replyTo:n}).success(function(e){d.dish.comments.push(e)})})}function h(e,t){var n=this;n.content="",n.title=e,n.closeDialog=function(){t.cancel()},n.submit=function(){""==n.content.trim()?t.cancel():t.hide(n.content)}}var d=this;d.dish={},a(),d.enterFlipBook=function(e){s.show({targetEvent:e,clickOutsideToClose:!0,templateUrl:"ng/views/dialogs/flipbook.html",controller:"DishDetailController",controllerAs:"book"})["finally"](function(){n.shownBook=!1}),n.shownBook=!0},e.$on("onRepeatLast",function(e,t,n){angular.element(t).parents("#dishBook").booklet({width:"100%",height:600,closed:!0,autoCenter:!0,pageNumbers:!1,pagePadding:0,hoverWidth:100})}),d.closeDialog=function(){s.cancel()},d.fbShare=function(e){var n=t.absUrl()+"/"+e._id;l.fbShare(n)},d.reply=function(e,t){var n="@"+e.userName;u(n,t,e._id)},d.collect=function(t){n.currentUser?c.collect(d.dish._id).then(function(e){e.success&&(d.dish.isCollected=!0)}):e.showLoginDialog(t,!0,"Login/SignUp first to save as favorite").then(function(e){n.currentUser=e,c.collect(d.dish._id).then(function(e){e.success&&(d.dish.isCollected=!0)})})},d.showInstructionPhoto=function(e,t){null!=e&&""!=e.trim()&&s.show({targetEvent:t,clickOutsideToClose:!0,template:'<md-dialog><md-dialog-content><img src="{{photo}}"></md-dialog-content></md-dialog>',controller:["$scope",function(t){t.photo=e}]})},d.newComment=function(t){n.currentUser?u("Comment",t,null):e.showLoginDialog(t,!0,"Login/SignUp first to leave a comment").then(function(e){n.currentUser=e,u("Comment",t,null)})},h.$inject=["title","$mdDialog"]}]),angular.module("spicyTaste").directive("contenteditable",function(){return{require:"ngModel",restrict:"A",link:function(e,t,n,i){i.$render=function(){t.html(i.$viewValue||"")},t.bind("blur",function(){e.$apply(function(){i.$setViewValue(t.html())})})}}}),angular.module("spicyTaste").directive("flipbook",function(){return{transclude:!1,restrict:"E",replace:!0,templateUrl:"ng/views/templates/flipbook.html",scope:{dish:"="}}}),angular.module("spicyTaste").directive("focus",function(){"use strict";return{restrict:"A",scope:{trigger:"@focus"},link:{post:function(e,t){e.$watch("trigger",function(e){"true"===e&&t[0].focus()})}}}}),angular.module("spicyTaste").directive("focusOn",function(){return{restrict:"A",scope:{focusValue:"=focusOn"},link:function(e,t){e.$watch("focusValue",function(e,n){e&&!n&&t[0].focus()})}}}),angular.module("spicyTaste").directive("onLastRepeat",["$timeout",function(e){"use strict";return function(t,n,i){t.$last&&e(function(){t.$emit("onRepeatLast",n,i)},0)}}]),angular.module("spicyTaste").directive("originalSrc",function(){"use strict";return{restrict:"A",scope:{originalSrc:"@"},link:function(e,t,n){t.on("load",function(){t.attr("src",e.originalSrc),t.css("background","none")})}}}),angular.module("spicyTaste").directive("scrollTo",function(){return{restrict:"A",link:function(e,t,n){var i=$(n.scrollTo);t.on("click",function(){$("html, body").animate({scrollTop:i.offset().top},600)})}}}),angular.module("spicyTaste").directive("showTime",["$window","UtilityService",function(e,t){"use strict";return{restrict:"A",scope:!0,link:function(n,i,o){var s=n.$eval(o.showTime),r=0;angular.isUndefined(s)||(r=s.offset);var c=t.debounce(function(){if(!i.hasClass("viewed")){var t=angular.element(e).scrollTop(),n=t+angular.element(e).height(),o=i.offset().top,s=o+i.height();0!==r&&(t-o>=0?o+=r:s-=r),n>=s&&o>=t&&i.removeClass("notViewed").addClass("viewed")}},200,!0);angular.element(e).on("scroll",c),n.$on("$destroy",c)}}}]),angular.module("spicyTaste").directive("socialShares",["SocialService","$location",function(e,t){"use strict";return{restrict:"E",replace:!0,templateUrl:"ng/views/templates/socialShares.html",link:function(n,i,o){i.find("#btnFB").click(function(){e.fbShare(t.absUrl())})}}}]),angular.module("spicyTaste").directive("topMenuReached",["$window","UtilityService",function(e,t){"use strict";return{restrict:"A",scope:!0,link:function(n,i,o){var s=i.offset().top-64,r={primaryTheme:!1,hidden:!1,text:"spicy taste"},c=n.$eval(o.topMenuReached),l=e.pageYOffset;l>=s&&n.setMenuBar(c);var a=t.debounce(function(){console.log("debounce called"),e.pageYOffset>=s?n.setMenuBar(c):n.setMenuBar(r),n.$apply()},150);angular.element(e).on("scroll",a),n.$on("$destroy",a)}}}]),angular.module("spicyTaste").factory("CommentService",["$http",function(e){"use strict";var t={},n="/api/comments";return t.getByDish=function(t,i){var o=n+"?dishId="+t;return i&&(o+="&limit="+i),e.get(o)},t.countByDish=function(t){return e.get(n+"/count/?dish="+t)},t}]),angular.module("spicyTaste").factory("DishService",["$http",function(e){"use strict";var t={},n="/api/dishes/";return t.all=function(){return e.get(n)},t.search=function(t){return e.get(n+"?search="+t)},t.searchByCategory=function(t){return e.get(n+"?category="+t)},t.searchByAuthor=function(t){return e.get(n+"?createdBy="+t)},t.limit=function(t){return e.get(n+"?limit="+t)},t.relate=function(t,n,i){return e({method:"GET",url:"/api/dishes",params:{id:t,limit:i,"tags[]":n}})},t.create=function(t){return e.post(n,t)},t.get=function(t){return e.get(n+t)},t.update=function(t,i){return e.put(n+t,i)},t["delete"]=function(t){return e["delete"](n+t)},t.addComment=function(t,i){return e.post(n+t+"/comments",i)},t.getInstructions=function(t){return e.get(n+t+"/instructions")},t.addInstruction=function(t,i){return e.post(n+t+"/instructions",i)},t.removeInstruction=function(t,i){return e["delete"](n+t+"/instructions/"+i)},t.getDifficulties=function(){return["初学","容易","一般","较难","专业"]},t}]),angular.module("spicyTaste").factory("SessionService",["$window",function(e){var t={};return t.getLocal=function(t){if(e.localStorage){var n=e.localStorage.getItem(t);return angular.fromJson(n)}return!1},t.setLocal=function(t,n){return e.localStorage&&e.localStorage.setItem(t,angular.toJson(n))},t}]),angular.module("spicyTaste").factory("SocialService",function(){var e={};return e.fbShare=function(e){FB.ui({method:"share",href:e},function(e){})},e}),angular.module("spicyTaste").factory("ThemeService",["$http","$filter",function(e,t){"use strict";var n={};return n.getAll=function(){return e.get("/api/themes")},n.get=function(t){return e.get("/api/themes/"+t)},n.searchBy=function(t){return e.get("/api/themes/?"+t)},n.create=function(t){return e.post("/api/themes/",t)},n.update=function(t,n){return e.put("/api/themes/"+t,n)},n.getOthers=function(e,i){var o="limit="+(i+1);return n.searchBy(o).then(function(n){var o=t("filter")(n.data,{name:e},function(e,t){return t.toLowerCase().trim()!==e.toLowerCase().trim()});return o.length>i?o.splice(0,1):o})},n}]),angular.module("spicyTaste").factory("UserService",["$http","$rootScope","$window","CONSTANTS",function(e,t,n,i){"use strict";var o={},s="/api/users/";return o.socialLogin=function(e){return o.searchBy("email="+e.email).then(function(t){return t.success?o.login(e.email,i.SOCIAL_PASS):o.create(e)})},o.login=function(t,n){return e.post("/api/auth",{email:t,password:n}).then(function(t){return e.defaults.headers.common["X-Auth"]=t.data.token,o.getById(t.data.userId)})},o.logout=function(){delete e.defaults.headers.common["X-Auth"],n.localStorage.removeItem(i.LOCAL_STORAGE_KEY),o.loginedUser=null},o.searchBy=function(t){return e.get("/api/users?"+t).then(function(e){return e.data})},o.getCurrentUser=function(){return e.get("/api/me").then(function(e){return o.getById(e.data)})},o.getById=function(t){return e.get(s+t).then(function(e){return e.data})},o.getProfile=function(){return e.get("/api/me/profile")},o.create=function(t){return e.post(s,t).then(function(){return o.login(t.email,t.password)})},o.update=function(t){return e.put(s+t.userId,t).then(function(e){return e.data})},o.collect=function(n){return e.put(s+t.currentUser._id+"/dishes/"+n).then(function(e){return e.data})},o.authorize=function(e){return o.getCurrentUser().then(function(t){return t&&e.indexOf(t.role)>=0?!0:!1},function(e){return console.log("err",e),!1})},o}]),angular.module("spicyTaste").factory("UtilityService",function(){"use strict";var e={};return e.debounce=function(e,t,n){var i;return function(){var o=this,s=arguments,r=function(){i=null,n||e.apply(o,s)},c=n&&!i;clearTimeout(i),i=setTimeout(r,t),c&&e.apply(o,s)}},e}),angular.module("spicyTaste").controller("DishAllController",["DishService","$scope",function(e,t){"use strict";function n(){t.setMenuBar({}),o.searchText="",o.selectedCategory="",o.hotSearch=["seafood","dessert","spicy","breakfast"],e.all().success(function(e){o.dishes=i(e)})}function i(e){for(var t=0;t<e.length;t++)e[t].blog&&e[t].blog.length>300&&(e[t].blog=e[t].blog.substring(0,299)+" ...");return e}var o=this;o.search=function(){""!==o.searchText.trim()&&e.search(o.searchText).success(function(e){o.dishes=i(e)})},o.selectCategory=function(t){o.selectedCategory=t,e.searchByCategory(t).success(function(e){o.dishes=i(e)})},o.showAll=function(){n()},n()}]),angular.module("spicyTaste").controller("DishEditController",["$scope","$mdDialog","$routeParams","DishService","$location","$timeout",function(e,t,n,i,o,s){"use strict";function r(e){var t=this;t.newPhoto="",t.closeDialog=function(){e.cancel()},t.submit=function(){e.hide(t.newPhoto)}}function c(e){var t=this;t.newInstruction={photo:"",text:""},t.closeDialog=function(){e.cancel()},t.submit=function(){e.hide(t.newInstruction)}}function l(){e.setMenuBar({}),i.get(n.dishId).success(function(e){a.dish=e}),i.getInstructions(n.dishId).success(function(e){a.dish.instructions=e}),a.difficulties=i.getDifficulties()}var a=this;a.saveDish=function(){i.update(n.dishId,a.dish).success(function(e){e.success&&(a.updateSuccess=!0),s(function(){a.updateSuccess=!1},1e3)})},a.removeInstruction=function(e){console.log("instructions",a.dish.instructions[e]),i.removeInstruction(n.dishId,a.dish.instructions[e]._id).success(function(t){a.dish.instructions.splice(e,1)})},a.removePhoto=function(e){a.dish.photos.splice(e,1),a.saveDish()},a.showAddPhotoDialog=function(e){t.show({targetEvent:e,controller:r,controllerAs:"photoDlg",clickOutsideToClose:!0,templateUrl:"ng/views/dialogs/addPhoto.html"}).then(function(e){a.dish.photos.push(e),a.saveDish()})},a.showAddInstructionDialog=function(e){t.show({targetEvent:e,controller:c,controllerAs:"instructionDlg",clickOutsideToClose:!0,templateUrl:"ng/views/dialogs/addInstruction.html"}).then(function(e){a.dish.instructions.push(e),i.addInstruction(n.dishId,e).success(function(e){})})},r.$inject=["$mdDialog"],c.$inject=["$mdDialog"],l()}]),angular.module("spicyTaste").controller("DishInstructionController",["DishService","$routeParams",function(e,t){"use strict";function n(){e.getInstructions(t.dishId).success(function(e){i.dish=e,i.dish.instructions.length>0&&(i.currentIndex=0)})}var i=this;i.isWithinShowRange=function(e){return e>=i.currentIndex-1&&e<=i.currentIndex+1},i.setNavClass=function(e){return e===i.currentIndex-1?"pre":e===i.currentIndex?"current":e===i.currentIndex+1?"next":void 0},i.showNext=function(){i.currentIndex+=1},i.showPre=function(){i.currentIndex-=1},n()}]),angular.module("spicyTaste").controller("DishShowController",["DishService","CommentService","$interval","$timeout","$routeParams","$filter","$rootScope","$scope",function(e,t,n,i,o,s,r,c){"use strict";function l(){e.addComment(d.dish._id,{content:d.newComment.content,replyTo:d.newComment.replyTo?d.newComment.replyTo._id:null}).success(function(e){d.newComment={},d.commentsCount+=1,d.allComments.unshift(e)})}function a(){t.getByDish(o.dishId,5).success(function(e){if(d.allComments=e,1===d.allComments.length&&(d.currentComment=d.allComments[0]),d.allComments.length>1){var t=0;h=n(function(){d.currentComment=d.allComments[t],t=++t%d.allComments.length},5e3)}})}function u(){d.dish={},d.relatedDishes={},d.currentComment=null,d.newComment={content:""},d.allComments=null,d.progress=0,d.showDifficulty=!0,d.showAllComments=!1,e.get(o.dishId).success(function(t){if(d.dish=t,d.dish.isCollected=!1,d.backgroundImage=d.dish.imageUrl,d.dish.difficultyText="Difficulty: "+e.getDifficulties()[d.dish.difficulty-1],d.dish.photos&&d.dish.photos.length>0){d.dish.photos.push(d.dish.imageUrl);var o=0,l=d.dish.photos.length,a=n(function(){d.backgroundImage=d.dish.photos[o],o=++o%l},6e3)}var u=20*d.dish.difficulty/2,m=n(function(){d.progress+=2},50,u,!0);if(i(function(){d.showDifficulty=!1},3e3),r.currentUser){var f=s("filter")(r.currentUser.favouriteDishes,{_id:d.dish._id},!0);f.length&&(d.dish.isCollected=!0)}c.$on("$destroy",function(){n.cancel(a),n.cancel(m),angular.isDefined(h)&&(n.cancel(h),h=void 0)})}),a(),t.countByDish(o.dishId).success(function(e){d.commentsCount=e})}var h,d=this;d.getAllComments=function(){t.getByDish(o.dishId,null).success(function(e){d.showAllComments=!0,d.currentComment=null,d.allComments=e})},d.createComment=function(e){r.currentUser?l():c.showLoginDialog(e,!0,"Login/SignUp first to leave a comment").then(function(e){r.currentUser=e,l()})},u()}]),angular.module("spicyTaste").controller("ThemeAdminEditController",["ThemeService","$routeParams","$timeout","DishService",function(e,t,n,i){"use strict";function o(){s.theme={},s.dishes=[],e.get(t.id).success(function(e){s.theme=e}),i.all().success(function(e){s.dishes=e})}var s=this;s.update=function(){e.update(s.theme._id,s.theme).success(function(e){e.success&&(s.updateSuccess=!0,n(function(){s.updateSuccess=!1},800))})},s.addDish=function(e){s.theme.components.push({title:"",displayOrder:s.theme.components.length+1,dish:e})},s.removeComponent=function(e){s.theme.components.splice(e,1)},s.getDisplayOrders=function(){for(var e=[],t=0;t<s.theme.components.length;t++)e.push(t+1);return e},o()}]),angular.module("spicyTaste").controller("ThemeAdminListController",["ThemeService","$location",function(e,t){"use strict";function n(){i.themes={},e.getAll().success(function(e){i.themes=e})}var i=this;i.create=function(){e.create({name:"new theme"}).success(function(e){t.path("/admin/themes/"+e.theme._id)})},n()}]),angular.module("spicyTaste").controller("ThemeAllController",["ThemeService",function(e){"use strict";function t(){e.getAll().success(function(e){n.themes=e})}var n=this;t()}]),angular.module("spicyTaste").controller("ThemeShowController",["ThemeService","$routeParams",function(e,t){"use strict";function n(){i.theme={},e.searchBy("name="+t.name).success(function(e){e&&e.length>0&&(i.theme=e[0],i.theme.slogans=i.theme.slogan.split("|"))}),e.getOthers(t.name,3).then(function(e){i.otherThemes=e})}var i=this;n()}]);