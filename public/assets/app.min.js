angular.module("spicyTaste",["ngRoute","angular-md5","ngMaterial","ngAnimate","ngMessages"]).constant("CONSTANTS",{FB_APP_ID:0x58e0e66b31adc,FACEBOOK:"FB",EMAIL:"EMAIL",SOCIAL_PASS:"P@ssw0rd",LOCAL_STORAGE_KEY:"spicyTasteUser",LATEST_COUNT:10,AWS_ACCESS_KEY:"AKIAIFO27R4VCOI3X5PQ",AWS_SECRECT_KEY:"pg7EfhmCaGh3NYSrX5phhPVd8D3Ixe5EfW1fsr7V"}),angular.module("spicyTaste").config(["$mdThemingProvider","$mdIconProvider",function(e,t){"use strict";var n=e.extendPalette("deep-orange",{500:"f27242"}),o=e.extendPalette("blue",{500:"6984b4",600:"6984b4"});e.definePalette("primaryOrange",n),e.definePalette("primaryBlue",o),e.theme("default").primaryPalette("primaryOrange").accentPalette("deep-orange"),e.theme("blue").primaryPalette("primaryBlue"),t.icon("menu","svg/ic_menu_24px.svg").icon("share","svg/ic_share_48px.svg").icon("login","svg/ic_account_circle_24px.svg").icon("recipes","svg/ic_event_note_48px.svg").icon("restaurants","svg/ic_restaurant_menu_48px.svg").icon("ingredients","svg/ic_receipt_48px.svg").icon("arrow","svg/ic_arrow_drop_up_48px.svg").icon("more","svg/ic_more_24px.svg").icon("time1","svg/ic_av_timer_24px.svg").icon("time2","svg/ic_access_time_24px.svg").icon("exit","svg/ic_exit_to_app_48px.svg").icon("photo","svg/ic_mms_24px.svg").icon("check","svg/ic_check_circle_24px.svg").icon("facebook","svg/facebook.svg").icon("twitter","svg/twitter.svg").icon("pinterest","svg/pinterest.svg").icon("comments","svg/ic_chat_48px.svg").icon("menu","svg/ic_menu_48px.svg").icon("favorite","svg/ic_favorite_24px.svg").icon("delete","svg/ic_delete_48px.svg").icon("add","svg/ic_add_circle_outline_48px.svg").icon("arrow-down","svg/ic_expand_more_48px.svg").icon("play","svg/ic_play_circle_outline_48px.svg").icon("search","svg/ic_search_48px.svg").icon("pin","svg/ic_attach_file_48px.svg").icon("clear","svg/ic_clear_all_48px.svg").icon("next","svg/ic_chevron_right_48px.svg").icon("pre","svg/ic_chevron_left_48px.svg").icon("edit","svg/ic_edit_48px.svg").icon("email","svg/ic_email_48px.svg").icon("lock","svg/ic_lock_outline_48px.svg").icon("user","svg/ic_person_outline_48px.svg").icon("go","svg/ic_play_circle_fill_48px.svg").icon("upload","svg/ic_cloud_upload_48px.svg").icon("send","svg/ic_send_48px.svg").icon("upload-error","svg/ic_cloud_off_48px.svg")}]),angular.module("spicyTaste").run(["$rootScope","$location","$window","CONSTANTS","UserService",function(e,t,n,o,i){"use strict";n.fbAsyncInit=function(){FB.init({appId:o.FB_APP_ID,cookie:!0,xfbml:!0,version:"v2.2"})},function(e,t,n){var o,i=e.getElementsByTagName(t)[0];e.getElementById(n)||(o=e.createElement(t),o.id=n,o.src="//connect.facebook.net/en_US/sdk.js",i.parentNode.insertBefore(o,i))}(document,"script","facebook-jssdk"),e.$on("$routeChangeStart",function(e,n){n&&n.access&&i.authorize(n.access.requirePermissions).then(function(e){e||t.path("not-authorize").replace()})}),e.$watch("currentUser",function(){e.$broadcast("logined")})}]),angular.module("spicyTaste").config(["$locationProvider","$routeProvider",function(e,t){"use strict";e.html5Mode(!0),t.when("/",{templateUrl:"ng/views/pages/home.html",controller:"HomeController",controllerAs:"home"}).when("/share",{templateUrl:"ng/views/pages/dish/share.html",controller:"DishShareController",controllerAs:"share"}).when("/themes",{templateUrl:"ng/views/pages/theme/all.html",controller:"ThemeAllController",controllerAs:"themeAll"}).when("/themes/:name",{templateUrl:"/ng/views/pages/theme/show.html",controller:"ThemeShowController",controllerAs:"themeShow"}).when("/recipts",{templateUrl:"ng/views/pages/dish/all.html",controller:"DishAllController",controllerAs:"dishAll"}).when("/dishes/:dishId",{templateUrl:"ng/views/pages/dish/show.html",controller:"DishShowController",controllerAs:"dishShow"}).when("/dishes/:dishId/instructions",{templateUrl:"ng/views/pages/dish/instruction.html",controller:"DishInstructionController",controllerAs:"dishInstruction"}).when("/me/dishes/:dishId",{templateUrl:"ng/views/pages/dish/edit.html",controller:"DishEditController",controllerAs:"dishManage"}).when("/login",{templateUrl:"ng/views/pages/user/login.html",controller:"LoginController",controllerAs:"login"}).when("/me",{templateUrl:"ng/views/pages/user/me.html",controller:"ProfileController",controllerAs:"profile"}).when("/not-authorize",{templateUrl:"ng/views/pages/not-authorize.html"}).when("/admin",{templateUrl:"/ng/views/pages/admin/index.html",access:{requirePermissions:["Admin"]}}).when("/admin/themes",{templateUrl:"/ng/views/pages/admin/theme/list.html",controller:"ThemeAdminListController",controllerAs:"themeList",access:{requirePermissions:["Admin"]}}).when("/admin/themes/:id",{templateUrl:"ng/views/pages/admin/theme/edit.html",controller:"ThemeAdminEditController",controllerAs:"themeEdit",access:{requirePermissions:["Admin"]}}).when("/admin/dishes",{templateUrl:"ng/views/pages/admin/dish/list.html",controller:"DishAdminListController",controllerAs:"dishList"})}]),angular.module("spicyTaste").controller("HomeController",["$scope","$mdMedia","DishService","CONSTANTS",function(e,t,n,o){"use strict";function i(){r.recipeTiles=[],e.$watch(function(){return t("sm")},function(t){e.smallScreen=t}),s()}function s(){n.limit(o.LATEST_COUNT).success(function(e){angular.forEach(e,function(e,t){var o={image:e.imageUrl,title:e.name,id:e._id,prepTime:e.prepTime,totalTime:e.totalTime,difficulty:n.getDifficulties()[e.difficulty-1],tags:e.tags,span:{row:1,col:1}};switch(t+1){case 1:o.span.row=o.span.col=2;break;case 2:case 3:break;case 4:o.span.col=2;break;case 5:case 6:break;case 7:o.span.row=o.span.col=2;break;case 8:case 9:break;case 10:o.span.col=2}r.recipeTiles.push(o)})})}var r=this;i()}]),angular.module("spicyTaste").controller("LoginController",["$injector","$rootScope","$scope","$mdDialog","UserService","md5","CONSTANTS","$http","SessionService",function(e,t,n,o,i,s,r,c,l){"use strict";function a(){h.title=h.dialogTitle,h.email="",h.password="",h.userName="",h.loginFailed=!1}function u(e){var n=c.defaults.headers.common["X-Auth"];l.setLocal(r.LOCAL_STORAGE_KEY,n),t.currentUser=e,o.hide()}var h=this;h.fbLogin=function(){FB.login(function(e){"connected"===e.status?FB.api("/me",function(e){var t={userName:e.name,email:e.email,password:r.SOCIAL_PASS,photoUrl:"http://graph.facebook.com/"+e.id+"/picture?type=large",linkedSocial:r.FACEBOOK};i.socialLogin(t).then(function(e){e.loginType=r.FACEBOOK,u(e)})}):"not_authorized"===e.status},{scope:"public_profile,email"})},h.login=function(){i.login(h.email,h.password).then(function(e){e.loginType=r.EMAIL,u(e)},function(){h.loginFailed=!0})},h.signUp=function(){var e={userName:h.userName,email:h.email,password:h.password,photoUrl:"http://www.gravatar.com/avatar/"+s.createHash(h.email),linkedSocial:r.EMAIL};i.create(e).then(function(e){e.loginType=r.EMAIL,u(e)})},a()}]),angular.module("spicyTaste").controller("MainController",["$rootScope","$scope","$location","$mdDialog","$http","SessionService","UserService","CONSTANTS",function(e,t,n,o,i,s,r,c){"use strict";function l(){a.showMobileMenu=!1,a.scrollTargetReached=!1,a.defaultMenu={primaryTheme:!1,hidden:!1,text:"SPICY TASTE"},a.menuBar=a.defaultMenu;var t=s.getLocal(c.LOCAL_STORAGE_KEY);t&&(console.log("token",t),i.defaults.headers.common["X-Auth"]=t,r.getCurrentUser().then(function(t){e.currentUser=t}))}var a=this;a.toggleMobileMenu=function(){a.showMobileMenu=!a.showMobileMenu},t.setMenuBar=function(e){a.menuBar={},angular.extend(a.menuBar,a.defaultMenu,e)},t.showLoginDialog=function(e,t,n){console.log("title",n);var i=o.show({clickOutsideToClose:!0,templateUrl:"ng/views/dialogs/login.html",targetEvent:e,controller:"LoginController",controllerAs:"login",locals:{dialogTitle:n},bindToController:!0});return t?i:void 0},l()}]),angular.module("spicyTaste").controller("ProfileController",["$location","$scope","$rootScope","$timeout","UserService","DishService",function(e,t,n,o,i,s){"use strict";function r(){t.setMenuBar({primaryTheme:!0}),i.getProfile().success(function(e){c.user=e.user,c.reciptsCount=e.reciptsCount})}var c=this;c.logout=function(){i.logout(),n.currentUser=null,e.path("/")},c.getRecipts=function(){t.showSpinner=!0,s.searchByAuthor(n.currentUser._id).success(function(e){c.allRecipts=e})},t.$on("onRepeatLast",function(){o(function(){t.showSpinner=!1},400)}),r()}]),angular.module("spicyTaste").directive("contenteditable",function(){"use strict";return{require:"ngModel",restrict:"A",link:function(e,t,n,o){o.$render=function(){t.html(o.$viewValue||"")},t.bind("blur",function(){e.$apply(function(){o.$setViewValue(t.html())})})}}}),angular.module("spicyTaste").directive("flipbook",function(){return{transclude:!1,restrict:"E",replace:!0,templateUrl:"ng/views/templates/flipbook.html",scope:{dish:"="}}}),angular.module("spicyTaste").directive("focus",function(){"use strict";return{restrict:"A",scope:{trigger:"@focus"},link:{post:function(e,t){e.$watch("trigger",function(e){"true"===e&&t[0].focus()})}}}}),angular.module("spicyTaste").directive("focusOn",function(){return{restrict:"A",scope:{focusValue:"=focusOn"},link:function(e,t){e.$watch("focusValue",function(e,n){e&&!n&&t[0].focus()})}}}),angular.module("spicyTaste").directive("imageUpload",["UtilityService",function(e){"use strict";return{restrict:"E",scope:{image:"="},replace:!0,transclude:!1,templateUrl:"ng/views/templates/imageUpload.html",controller:["$scope",function(e){e.uploadStatus={progress:0,done:!1,error:!1,imageUrl:""},e.changeUploadStatus=function(t){angular.extend(e.uploadStatus,t),t.imageUrl&&""!==t.imageUrl.trim()&&(e.image=t.imageUrl),e.$apply()}}],link:function(t,n){var o=n.find("input.file");o.on("change",function(n){t.changeUploadStatus({progress:0,error:!1,done:!1});var o=n.target.files,i=o[0];e.awsUpload(i,null,t.changeUploadStatus)})}}}]),angular.module("spicyTaste").directive("onLastRepeat",["$timeout",function(e){"use strict";return function(t,n,o){t.$last&&e(function(){t.$emit("onRepeatLast",n,o)},0)}}]),angular.module("spicyTaste").directive("originalSrc",function(){"use strict";return{restrict:"A",scope:{originalSrc:"@"},link:function(e,t,n){t.on("load",function(){t.attr("src",e.originalSrc),t.css("background","none")})}}}),angular.module("spicyTaste").directive("scrollTo",function(){return{restrict:"A",link:function(e,t,n){var o=$(n.scrollTo);t.on("click",function(){$("html, body").animate({scrollTop:o.offset().top},600)})}}}),angular.module("spicyTaste").directive("showTime",["$window","UtilityService",function(e,t){"use strict";return{restrict:"A",scope:!0,link:function(n,o,i){var s=n.$eval(i.showTime),r=0;angular.isUndefined(s)||(r=s.offset);var c=t.debounce(function(){if(!o.hasClass("viewed")){var t=angular.element(e).scrollTop(),n=t+angular.element(e).height(),i=o.offset().top,s=i+o.height();0!==r&&(t-i>=0?i+=r:s-=r),n>=s&&i>=t&&o.removeClass("notViewed").addClass("viewed")}},200,!0);angular.element(e).on("scroll",c),n.$on("$destroy",c)}}}]),angular.module("spicyTaste").directive("socialShares",["SocialService","$location",function(e,t){"use strict";return{restrict:"E",replace:!0,templateUrl:"ng/views/templates/socialShares.html",link:function(n,o,i){o.find("#btnFB").click(function(){e.fbShare(t.absUrl())})}}}]),angular.module("spicyTaste").directive("topMenuReached",["$window","UtilityService",function(e,t){"use strict";return{restrict:"A",scope:!0,link:function(n,o,i){var s=o.offset().top-64,r={primaryTheme:!1,hidden:!1,text:"spicy taste"},c=n.$eval(i.topMenuReached),l=e.pageYOffset;l>=s&&n.setMenuBar(c);var a=t.debounce(function(){console.log("debounce called"),e.pageYOffset>=s?n.setMenuBar(c):n.setMenuBar(r),n.$apply()},150);angular.element(e).on("scroll",a),n.$on("$destroy",a)}}}]),angular.module("spicyTaste").factory("CommentService",["$http",function(e){"use strict";var t={},n="/api/comments";return t.getByDish=function(t,o){var i=n+"?dishId="+t;return o&&(i+="&limit="+o),e.get(i)},t.countByDish=function(t){return e.get(n+"/count/?dish="+t)},t}]),angular.module("spicyTaste").factory("DishService",["$http",function(e){"use strict";var t={},n="/api/dishes/";return t.all=function(){return e.get(n)},t.search=function(t){return e.get(n+"?search="+t)},t.searchByCategory=function(t){return e.get(n+"?category="+t)},t.searchByAuthor=function(t){return e.get(n+"?createdBy="+t)},t.limit=function(t){return e.get(n+"?limit="+t)},t.relate=function(t,n,o){return e({method:"GET",url:"/api/dishes",params:{id:t,limit:o,"tags[]":n}})},t.create=function(t){return e.post(n,t)},t.get=function(t){return e.get(n+t)},t.update=function(t,o){return e.put(n+t,o)},t["delete"]=function(t){return e["delete"](n+t)},t.addComment=function(t,o){return e.post(n+t+"/comments",o)},t.getDishWithInstructions=function(t){return e.get(n+t+"/instructions")},t.addInstruction=function(t,o){return e.post(n+t+"/instructions",o)},t.removeInstruction=function(t,o){return e["delete"](n+t+"/instructions/"+o)},t.getDifficulties=function(){return["初学","容易","一般","较难","专业"]},t}]),angular.module("spicyTaste").factory("SessionService",["$window",function(e){var t={};return t.getLocal=function(t){if(e.localStorage){var n=e.localStorage.getItem(t);return angular.fromJson(n)}return!1},t.setLocal=function(t,n){return e.localStorage&&e.localStorage.setItem(t,angular.toJson(n))},t}]),angular.module("spicyTaste").factory("SocialService",function(){var e={};return e.fbShare=function(e){FB.ui({method:"share",href:e},function(e){})},e}),angular.module("spicyTaste").factory("ThemeService",["$http","$filter",function(e,t){"use strict";var n={};return n.getAll=function(){return e.get("/api/themes")},n.get=function(t){return e.get("/api/themes/"+t)},n.searchBy=function(t){return e.get("/api/themes/?"+t)},n.create=function(t){return e.post("/api/themes/",t)},n.update=function(t,n){return e.put("/api/themes/"+t,n)},n.getOthers=function(e,o){var i="limit="+(o+1);return n.searchBy(i).then(function(n){var i=t("filter")(n.data,{name:e},function(e,t){return t.toLowerCase().trim()!==e.toLowerCase().trim()});return i.length>o?i.splice(0,1):i})},n}]),angular.module("spicyTaste").factory("UserService",["$http","$rootScope","$window","CONSTANTS",function(e,t,n,o){"use strict";var i={},s="/api/users/";return i.socialLogin=function(e){return i.searchBy("email="+e.email).then(function(t){return t.success?i.login(e.email,o.SOCIAL_PASS):i.create(e)})},i.login=function(t,n){return e.post("/api/auth",{email:t,password:n}).then(function(t){return e.defaults.headers.common["X-Auth"]=t.data.token,i.getById(t.data.userId)})},i.logout=function(){delete e.defaults.headers.common["X-Auth"],n.localStorage.removeItem(o.LOCAL_STORAGE_KEY),i.loginedUser=null},i.searchBy=function(t){return e.get("/api/users?"+t).then(function(e){return e.data})},i.getCurrentUser=function(){return e.get("/api/me").then(function(e){return i.getById(e.data)})},i.getById=function(t){return e.get(s+t).then(function(e){return e.data})},i.getProfile=function(){return e.get("/api/me/profile")},i.create=function(t){return e.post(s,t).then(function(){return i.login(t.email,t.password)})},i.update=function(t){return e.put(s+t.userId,t).then(function(e){return e.data})},i.collect=function(n){return e.put(s+t.currentUser._id+"/dishes/"+n).then(function(e){return e.data})},i.authorize=function(e){return i.getCurrentUser().then(function(t){return t&&e.indexOf(t.role)>=0?!0:!1},function(e){return console.log("err",e),!1})},i}]),angular.module("spicyTaste").factory("UtilityService",["CONSTANTS","$timeout",function(e,t){"use strict";var n={};return n.debounce=function(e,t,n){var o;return function(){var i=this,s=arguments,r=function(){o=null,n||e.apply(i,s)},c=n&&!o;clearTimeout(o),o=setTimeout(r,t),c&&e.apply(i,s)}},n.awsUpload=function(n,o,i){AWS.config.update({accessKeyId:e.AWS_ACCESS_KEY,secretAccessKey:e.AWS_SECRECT_KEY}),AWS.config.region="us-west-2",console.log("aws config",AWS.config);var s=null===o?"spicytaste-tmp-photos":"spicytaste-photos/"+o,r=new AWS.S3({params:{Bucket:s}}),c={Key:n.name,ContentType:n.type,Body:n,ServerSideEncryption:"AES256"},l=r.putObject(c);return setTimeout(l.abort.bind(l),5e3),i?void l.on("httpError",function(e,n){console.log("upload err",e),i({error:!0}),t(function(){i({error:!1})},300)}).on("httpDone",function(e){console.log("awsUpload done",e),i({imageUrl:"https://s3-us-west-2.amazonaws.com/"+s+"/"+n.name}),t(function(){i({done:!0,progress:0})},300)}).on("httpUploadProgress",function(e,t){i({progress:Math.round(e.loaded/e.total*100)})}).on("error",function(e){console.log("aws putObject error",e)}).send():l},n}]),angular.module("spicyTaste").controller("DishAdminListController",["DishService",function(e){"use strict";var t=this;e.all().success(function(e){t.dishes=e}),t.deleteDish=function(n){var o=t.dishes[n];e["delete"](o._id).success(function(){t.dishes.splice(n,1)})}}]),angular.module("spicyTaste").controller("DishAllController",["DishService","$scope",function(e,t){"use strict";function n(){t.setMenuBar({}),i.searchText="",i.selectedCategory="",i.hotSearch=["seafood","dessert","spicy","breakfast"],e.all().success(function(e){i.dishes=o(e)})}function o(e){for(var t=0;t<e.length;t++)e[t].blog&&e[t].blog.length>300&&(e[t].blog=e[t].blog.substring(0,299)+" ...");return e}var i=this;i.search=function(){""!==i.searchText.trim()&&e.search(i.searchText).success(function(e){i.dishes=o(e)})},i.selectCategory=function(t){i.selectedCategory=t,e.searchByCategory(t).success(function(e){i.dishes=o(e)})},i.showAll=function(){n()},n()}]),angular.module("spicyTaste").controller("DishEditController",["$scope","$mdDialog","$routeParams","DishService","$location","$timeout",function(e,t,n,o,i,s){"use strict";function r(e){var t=this;t.newPhoto="",t.closeDialog=function(){e.cancel()},t.submit=function(){e.hide(t.newPhoto)}}function c(e){var t=this;t.newInstruction={photo:"",text:""},t.closeDialog=function(){e.cancel()},t.submit=function(){e.hide(t.newInstruction)}}function l(){e.setMenuBar({}),o.getDishWithInstructions(n.dishId).success(function(e){a.dish=e,console.log("dish",e);for(var t=a.dish.photos.length,n=t;5>n;n++)a.dish.photos.push("")}),a.difficulties=o.getDifficulties()}var a=this;a.saveDish=function(){o.update(n.dishId,a.dish).success(function(e){e.success&&(a.updateSuccess=!0),s(function(){a.updateSuccess=!1},1e3)})},a.removeInstruction=function(e){console.log("instructions",a.dish.instructions[e]),o.removeInstruction(n.dishId,a.dish.instructions[e]._id).success(function(t){a.dish.instructions.splice(e,1)})},a.removePhoto=function(e){a.dish.photos.splice(e,1),a.saveDish()},a.showAddPhotoDialog=function(e){t.show({targetEvent:e,controller:r,controllerAs:"photoDlg",clickOutsideToClose:!0,templateUrl:"ng/views/dialogs/addPhoto.html"}).then(function(e){a.dish.photos.push(e),a.saveDish()})},a.showAddInstructionDialog=function(e){t.show({targetEvent:e,controller:c,controllerAs:"instructionDlg",clickOutsideToClose:!0,templateUrl:"ng/views/dialogs/addInstruction.html"}).then(function(e){a.dish.instructions.push(e),o.addInstruction(n.dishId,e).success(function(e){})})},r.$inject=["$mdDialog"],c.$inject=["$mdDialog"],l()}]),angular.module("spicyTaste").controller("DishInstructionController",["DishService","$routeParams",function(e,t){"use strict";function n(){e.getDishWithInstructions(t.dishId).success(function(e){o.dish=e,o.dish.instructions.length>0&&(o.currentIndex=0)})}var o=this;o.isWithinShowRange=function(e){return e>=o.currentIndex-1&&e<=o.currentIndex+1},o.setNavClass=function(e){return e===o.currentIndex-1?"pre":e===o.currentIndex?"current":e===o.currentIndex+1?"next":void 0},o.showNext=function(){o.currentIndex+=1},o.showPre=function(){o.currentIndex-=1},n()}]),angular.module("spicyTaste").controller("DishShareController",["$scope","DishService","$location","$rootScope","$timeout",function(e,t,n,o,i){"use strict";function s(){e.setMenuBar({primaryTheme:!0}),r.newRecipt={name:"",imageUrl:""},r.showLogin=!0,r.isLogined=!angular.isUndefined(o.currentUser)&&null!==o.currentUser}var r=this;e.$on("logined",function(){r.isLogined=!0}),r.create=function(){r.newRecipt.createdBy=o.currentUser._id,t.create(r.newRecipt).success(function(e){n.path("/me/dishes/"+e.dish._id)})},r.toggleLogin=function(e){e?(r.showSignUp=!1,i(function(){r.showLogin=!0},250)):(r.showLogin=!1,i(function(){r.showSignUp=!0},250))},s()}]),angular.module("spicyTaste").controller("DishShowController",["DishService","CommentService","$interval","$timeout","$routeParams","$filter","$rootScope","$scope",function(e,t,n,o,i,s,r,c){"use strict";function l(){e.addComment(d.dish._id,{content:d.newComment.content,replyTo:d.newComment.replyTo?d.newComment.replyTo._id:null}).success(function(e){d.newComment={},d.commentsCount+=1,d.allComments.unshift(e)})}function a(){t.getByDish(i.dishId,5).success(function(e){if(d.allComments=e,1===d.allComments.length&&(d.currentComment=d.allComments[0]),d.allComments.length>1){var t=0;h=n(function(){d.currentComment=d.allComments[t],t=++t%d.allComments.length},5e3)}})}function u(){d.dish={},d.relatedDishes={},d.currentComment=null,d.newComment={content:""},d.allComments=null,d.progress=0,d.showDifficulty=!0,d.showAllComments=!1,e.get(i.dishId).success(function(t){if(d.dish=t,d.dish.isCollected=!1,d.backgroundImage=d.dish.imageUrl,d.dish.difficultyText="Difficulty: "+e.getDifficulties()[d.dish.difficulty-1],d.dish.photos&&d.dish.photos.length>0){d.dish.photos.push(d.dish.imageUrl);var i=0,l=d.dish.photos.length,a=n(function(){d.backgroundImage=d.dish.photos[i],i=++i%l},6e3)}var u=20*d.dish.difficulty/2,m=n(function(){d.progress+=2},50,u,!0);if(o(function(){d.showDifficulty=!1},3e3),r.currentUser){var g=s("filter")(r.currentUser.favouriteDishes,{_id:d.dish._id},!0);g.length&&(d.dish.isCollected=!0)}c.$on("$destroy",function(){n.cancel(a),n.cancel(m),angular.isDefined(h)&&(n.cancel(h),h=void 0)})}),a(),t.countByDish(i.dishId).success(function(e){d.commentsCount=e})}var h,d=this;d.getAllComments=function(){t.getByDish(i.dishId,null).success(function(e){d.showAllComments=!0,d.currentComment=null,d.allComments=e})},d.createComment=function(e){r.currentUser?l():c.showLoginDialog(e,!0,"Login/SignUp first to leave a comment").then(function(){l()})},u()}]),angular.module("spicyTaste").controller("ThemeAdminEditController",["ThemeService","$routeParams","$timeout","DishService",function(e,t,n,o){"use strict";function i(){s.theme={},s.dishes=[],e.get(t.id).success(function(e){s.theme=e}),o.all().success(function(e){s.dishes=e})}var s=this;s.update=function(){e.update(s.theme._id,s.theme).success(function(e){e.success&&(s.updateSuccess=!0,n(function(){s.updateSuccess=!1},800))})},s.addDish=function(e){s.theme.components.push({title:"",displayOrder:s.theme.components.length+1,dish:e})},s.removeComponent=function(e){s.theme.components.splice(e,1)},s.getDisplayOrders=function(){for(var e=[],t=0;t<s.theme.components.length;t++)e.push(t+1);return e},i()}]),angular.module("spicyTaste").controller("ThemeAdminListController",["ThemeService","$location",function(e,t){"use strict";function n(){o.themes={},e.getAll().success(function(e){o.themes=e})}var o=this;o.create=function(){e.create({name:"new theme"}).success(function(e){t.path("/admin/themes/"+e.theme._id)})},n()}]),angular.module("spicyTaste").controller("ThemeAllController",["ThemeService",function(e){"use strict";function t(){e.getAll().success(function(e){n.themes=e})}var n=this;t()}]),angular.module("spicyTaste").controller("ThemeShowController",["ThemeService","$routeParams",function(e,t){"use strict";function n(){o.theme={},e.searchBy("name="+t.name).success(function(e){e&&e.length>0&&(o.theme=e[0],o.theme.slogans=o.theme.slogan.split("|"))}),e.getOthers(t.name,3).then(function(e){o.otherThemes=e})}var o=this;n()}]);